<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="Generator" content="EditPlus®">
    <meta name="Author" content="">
    <meta name="Keywords" content="">
    <meta name="Description" content="">
    <title>Document</title>
    <script
            src="https://code.jquery.com/jquery-3.4.1.js"
            integrity="sha256-WpOohJOqMqqyKL9FccASB9O0KwACQJpFTUBLTYOVvVU="
            crossorigin="anonymous"></script>

    <script src="https://www.echartsjs.com/examples/vendors/echarts/echarts.min.js"></script>

    <script>
        String.prototype.endWith = function (s) {
            if (s == null || s == "" || this.length == 0 || s.length > this.length)
                return false;
            if (this.substring(this.length - s.length) == s)
                return true;
            else
                return false;
        };
        String.prototype.startWith = function (s) {
            if (s == null || s == "" || this.length == 0 || s.length > this.length)
                return false;
            if (this.substr(0, s.length) == s)
                return true;
            else
                return false;
        }
    </script>
    <style type="text/css">

        .bar {
            float: left;
            width: 25px;
        }

        .triangle {
            width: 0px;
            height: 0px;
            border-bottom: 20px solid blue;
            border-left: 10px solid transparent;
            border-right: 10px solid transparent;
            margin: 2px;
            float: left;
        }

        .raise {
            border: 10px solid green;
        }

        .fall {
            border: 10px solid red;
        }

        .cycle {
            width: 0px;
            height: 0px;
            -moz-border-radius: 10px;
            -webkit-border-radius: 10px;
            border-radius: 20px;
            margin: 2px;
            float: left;
        }

    </style>


</head>
<body style="background-color: darkgrey">
<!--
<div class="triangle"></div>
<div class="raise cycle"></div>
<div class="fall cycle"></div>
-->
<div style="display: none;">
    <input type="button" value="数据" onclick="show()">
    <input type="button" value="测试" onclick="testBuy()">
    <span>规则</span><input type="text" id="rule" value="222">
    <span>过滤</span><input type="text" id="ignore" value="2222">
    <span>买单</span><input type="text" id="buy" value="1">
</div>
<div id="chart" style="width:700px;height:450px;margin: 10px;"></div>
<div id="show" style="width: 100000px;"></div>
<div id="result" style="float:left;"></div>

<script>
    var data = [];
    var url = "https://bird.ioliu.cn/v2?url=https://option.aofex.com/webApi/scene/getResultList?timeId=1&pairId=1&pageNo=1&pageSize=40";
    var klineUrl150 = "https://bird.ioliu.cn/v2?url=https://option.aofex.com/webApi/scene/getKline?symbol=BTC/USDT&period=5min&size=200";
    var wssURL = "wss://option.aofex.com/websocket/optionKline/BTC-USDT/5min";

    function getLocalTime(nS) {
        return new Date(parseInt(nS) * 1000).toLocaleString().replace(/:\d{1,2}$/, ' ');
    }


    function showResult() {
        var htmlObj = $.ajax({"url": url, "async": false});
        var resp = JSON.parse(htmlObj.responseText);
        var list = resp.result.list;
        data = [];
        var html = '<div  class ="bar">';
        var preFlag;
        for (var i = list.length - 1; i >= 0; i--) {
            var title = list.length - i;
            var obj = list[i];
            var flag = obj.upOrDown;
            data.push(flag);
            if (i == list.length - 1) {
                preFlag = flag
            } else if (flag != preFlag) {
                preFlag = flag;
                html += '</div><div  class ="bar">';
            }
            switch (flag) {
                case 4:
                    html += '<div class="triangle" title="' + title + '"></div>';
                    break;
                case 2:
                    html += '<div class="fall cycle"  title="' + title + '"></div>';
                    break;
                case 1:
                    html += '<div class="raise cycle"  title="' + title + '"></div>';
                    break;
            }
        }
        $("#show").html(html);
    }

    function testBuy() {
        var rule = $("#rule").val();
        var ignore = $("#ignore").val();
        var buy = $("#buy").val();
        var testStr = "";
        var times = 1;
        var result = "";
        for (var i = 0; i < data.length - 1; i++) {
            testStr += data[i];
            if (testStr.length > 20) {
                testStr = testStr.substring(10);
            }
            //如果找到匹配的
            if (testStr.endWith(rule) && !testStr.endWith(ignore)) {
                if (data[i + 1] + "" == buy + "") {
                    result += "买点" + (i + 1) + "购买成功  基础投注倍数 " + times + "<br>";
                    times = 1;
                } else {
                    result += "买点" + (i + 1) + "购买失败  基础投注倍数 " + times + "<br>";
                    times += 1;
                }
            }
        }
        $("#result").html(result);
    }
</script>
<script type="text/javascript">


    // 基于准备好的dom，初始化echarts实例
    var myChart = echarts.init(document.getElementById('chart'));

    var upColor = '#00da3c';
    var downColor = '#ec0000';
    var kLineData;
    var lastData;


    function splitData(rawData) {
        var candles = JSON.parse(rawData).result.data;
        var categoryData = [];
        var values = [];
        var volumes = [];
        for (var i = candles.length - 1; i >= 0; i--) {
            var item = candles[i];
            categoryData.push(getLocalTime(item["openDate"]));
            var dataArr = [];
            dataArr.push(item["open"]);
            dataArr.push(item["close"]);
            dataArr.push(item["low"]);
            dataArr.push(item["high"]);
            values.push(dataArr);
        }

        kLineData = {
            categoryData: categoryData,
            values: values
        };
    }

    function req(url) {
        //   "http://localhost:8081/chart/EOS-USD-191018/900?overbought=75&oversold=25"
        $.get(url, function (rawData) {
            splitData(rawData);
        });
    }


    function showKLine() {
        if (!kLineData || kLineData.categoryData.length == 0) {
            return;
        }

        myChart.setOption(option = {
            backgroundColor: 'gray',
            animation: false,
            legend: {
                bottom: 10,
                left: 'center',
                data: ['BTC-5M', 'MA5', 'MA10', 'MA20', 'MA30']
            },
            tooltip: {
                trigger: 'axis',
                axisPointer: {
                    type: 'cross'
                },
                backgroundColor: 'rgba(245, 245, 245, 0.8)',
                borderWidth: 1,
                borderColor: '#ccc',
                padding: 10,
                textStyle: {
                    color: '#000'
                },
                position: function (pos, params, el, elRect, size) {
                    var obj = {top: 10};
                    obj[['left', 'right'][+(pos[0] < size.viewSize[0] / 2)]] = 30;
                    return obj;
                }
                // extraCssText: 'width: 170px'
            },
            axisPointer: {
                link: {xAxisIndex: 'all'},
                label: {
                    backgroundColor: '#777'
                }
            },
            toolbox: {
                feature: {
                    dataZoom: {
                        yAxisIndex: false
                    },
                    brush: {
                        type: ['lineX', 'clear']
                    }
                }
            },
            brush: {
                xAxisIndex: 'all',
                brushLink: 'all',
                outOfBrush: {
                    colorAlpha: 0.1
                }
            },
            visualMap: {
                show: false,
                seriesIndex: 5,
                dimension: 2,
                pieces: [{
                    value: 1,
                    color: downColor
                }, {
                    value: -1,
                    color: upColor
                }]
            },
            grid: [
                {
                    left: '10%',
                    right: '8%',
                    height: '65%'
                }
            ],
            xAxis: [
                {
                    type: 'category',
                    data: kLineData.categoryData.concat(lastData.categoryData),
                    scale: true,
                    boundaryGap: false,
                    axisLine: {onZero: false},
                    splitLine: {show: false},
                    splitNumber: 20,
                    min: 'dataMin',
                    max: 'dataMax',
                    axisPointer: {
                        z: 100
                    }
                }
            ],
            yAxis: [
                {
                    scale: true,
                    splitLine: {show: false}
                }
            ],
            dataZoom: [
                {
                    type: 'inside',
                    xAxisIndex: [0],
                    start: 70,
                    end: 100
                },
                {
                    show: true,
                    xAxisIndex: [0],
                    type: 'slider',
                    top: '85%',
                    start: 70,
                    end: 100
                }
            ],
            series: [
                {
                    name: 'BTC-5M',
                    type: 'candlestick',
                    data: kLineData.values.concat(lastData.values),
                    itemStyle: {
                        normal: {
                            color: upColor,
                            color0: downColor,
                            borderColor: null,
                            borderColor0: null
                        }
                    },
                    tooltip: {
                        formatter: function (param) {
                            param = param[0];
                            return [
                                'Date: ' + param.name + '<hr size=1 style="margin: 3px 0">',
                                '高: ' + param.data[3] + '<br/>',
                                '低: ' + param.data[2] + '<br/>',
                                '开: ' + param.data[0] + '<br/>',
                                '收: ' + param.data[1] + '<br/>'
                            ].join('');
                        }
                    }
                }
            ]
        }, true);

    }

    //WSS
    var ws = new WebSocket(wssURL);
    //readyState属性返回实例对象的当前状态，共有四种。
    //CONNECTING：值为0，表示正在连接。
    //OPEN：值为1，表示连接成功，可以通信了。
    //CLOSING：值为2，表示连接正在关闭。
    //CLOSED：值为3，表示连接已经关闭，或者打开连接失败
    //例如：if (ws.readyState == WebSocket.CONNECTING) { }

    //【用于指定连接成功后的回调函数】
    ws.onopen = function (evt) {
        console.log("Connection open ...");

        try {
            req(klineUrl150);
            showResult();
        } catch (e) {

        }
//        ws.send("Hello WebSockets!");
    };
    //ws.addEventListener('open', function (event) {
    //    ws.send('Hello Server!');
    //};

    //【用于指定收到服务器数据后的回调函数】
    //【服务器数据有可能是文本，也有可能是二进制数据，需要判断】
    ws.onmessage = function (event) {
        var data = JSON.parse(event.data).data;
        var categoryData = [];
        categoryData.push(getLocalTime(data["openDate"]));
        var dataArr = [];
        var values = [];
        dataArr.push(data["open"]);
        dataArr.push(data["close"]);
        dataArr.push(data["low"]);
        dataArr.push(data["high"]);
        values.push(dataArr);
        lastData = {categoryData: categoryData, values: values};
        showKLine();
    };

    //[【于指定连接关闭后的回调函数。】
    ws.onclose = function (evt) {
        console.log("Connection closed.");
    };


    ws.onerror = function (event) {
    };


    setInterval(function () {
        try {
            upgrade();
        } catch (e) {

        }
    }, 10000);

    function upgrade() {
        var date = new Date();
        var minute = date.getMinutes();
        ws.send(date.getTime())
        var upgradeArr = [1, 6, 11, 16, 21, 26, 31, 36, 41, 46, 51, 56];
        if (upgradeArr.indexOf(minute) >= 0) {
            try {
                req(klineUrl150);
                showResult();
            } catch (e) {

            }

        }
        var suggestArr = [3, 8, 13, 18, 23, 28, 33, 38, 43, 48, 53, 58];
        if (suggestArr.indexOf(minute) >= 0) {
            try {
                suggest();
            } catch (e) {

            }
        }
    }

    var lastCategory = "";

    function suggest() {
        var category = lastData.categoryData[0];
        if (!lastData || category == lastCategory) {
            return;
        }
        var item = lastData.values[0];
        var ratio = (item[1] - item[0]) / item[0];
        var lastChar = 4;
        if (ratio < -0.0003) {
            lastChar = 2;
        } else if (ratio > 0.0003) {
            lastChar = 1;
        }
        var testStr = "";
        for (var i = 0; i < data.length - 1; i++) {
            testStr += data[i];
            if (testStr.length > 20) {
                testStr = testStr.substring(10);
            }
        }
        testStr += lastChar;
        var msg;
        if (testStr.endWith("111")) {
            msg = category + " 连涨行情出现";
            lastCategory = category;
        } else if (testStr.endWith("222")) {
            msg = category + " 连跌行情出现";
            lastCategory = category;
        }
        if (!!msg) {
            var audio = new Audio("abc.mp3");
            audio.play();
            msg += "<br>";
            $("#result").append(msg);

        }
    }


</script>


</body>
</html>
